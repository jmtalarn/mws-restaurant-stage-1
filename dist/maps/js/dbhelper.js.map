{"version":3,"names":[],"mappings":"","sources":["js/dbhelper.js"],"sourcesContent":["/*global google*/\r\n/**\r\n * Common database helper functions.\r\n */\r\nDBHelper = (function () {\r\n\r\n    const port = 1337; // Change this to your server port\r\n    const DATABASE_URL = `http://localhost:${port}/restaurants/`;\r\n    const DB_NAME = `restaurant-reviews`;\r\n    const RESTAURANTS = `restaurants`;\r\n\r\n    dbPromise = idb.open(DB_NAME, 1, (upgradeDb) => {\r\n        var store = upgradeDb.createObjectStore(RESTAURANTS, {\r\n            keyPath: 'id'\r\n        });\r\n        store.createIndex('by-cuisine', 'cuisine_type', {\r\n            unique: false\r\n        });\r\n        store.createIndex('by-neighborhood', 'neighborhood', {\r\n            unique: false\r\n        });\r\n        store.createIndex('by-neighborhood-cuisine', ['neighborhood', 'cuisine_type'], {\r\n            unique: false\r\n        });\r\n\r\n\r\n    });\r\n    dbPromise.then(db => {\r\n\r\n        fetch(DATABASE_URL)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw Error({\r\n                        code: response.status,\r\n                        message: response.statusText\r\n                    });\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(json => {\r\n                const tx = db.transaction(RESTAURANTS, 'readwrite');\r\n                json.forEach(restaurant => {\r\n                    tx.objectStore(RESTAURANTS).put(restaurant)\r\n                });\r\n                return tx.complete;\r\n\r\n            }).then(t => console.log(\"Loaded restaurants data\"))\r\n\r\n    });\r\n\r\n\r\n\r\n\r\n\r\n\r\n    return {\r\n        getAllRestaurants: () => {\r\n            return dbPromise.then(db => {\r\n                return db.transaction(RESTAURANTS)\r\n                    .objectStore(RESTAURANTS).getAll();\r\n            });\r\n        },\r\n        getRestaurantById: (id) => {\r\n            return dbPromise.then(db => {\r\n                return db.transaction(RESTAURANTS)\r\n                    .objectStore(RESTAURANTS).get(id);\r\n            });\r\n        },\r\n\r\n        getCuisines: () => {\r\n            let keys = new Set();\r\n            return dbPromise\r\n                .then(db => db.transaction(RESTAURANTS)\r\n                    .objectStore(RESTAURANTS)\r\n                    .index('by-cuisine')\r\n                    .openKeyCursor()\r\n                    .then(function cursorKeyIterate(cursor) {\r\n                        if (!cursor) return;\r\n                        keys.add(cursor.key);\r\n                        return cursor.continue().then(cursorKeyIterate);\r\n                    })).then(() => {\r\n                    console.log(Array.from(keys));\r\n                    return Array.from(keys)\r\n                });\r\n        },\r\n\r\n        getNeighborhoods: () => {\r\n            let keys = new Set();\r\n            return dbPromise\r\n                .then(db => db.transaction(RESTAURANTS)\r\n                    .objectStore(RESTAURANTS)\r\n                    .index('by-neighborhood')\r\n                    .openKeyCursor()\r\n                    .then(function cursorKeyIterate(cursor) {\r\n                        if (!cursor) return;\r\n                        keys.add(cursor.key);\r\n                        return cursor.continue().then(cursorKeyIterate);\r\n                    })).then(() => {\r\n                    return Array.from(keys)\r\n                });\r\n\r\n        },\r\n        getRestaurantsByCuisine: (cuisine) => {\r\n            var restaurants = [];\r\n            return dbPromise\r\n                .then(db => {\r\n                    db.transaction(RESTAURANTS)\r\n                        .objectStore(RESTAURANTS)\r\n                        .index('by-cuisine').openCursor(IDBKeyRange.only(cuisine)).then(function cursorIterate(cursor) {\r\n                            if (!cursor) return;\r\n                            console.log(cursor.value);\r\n                            restaurants.push(cursor.value);\r\n                            return cursor.continue().then(cursorIterate);\r\n                        }).then(() => {\r\n                            return restaurants;\r\n                        })\r\n                });\r\n        },\r\n        getRestaurantsByNeighborhood: (neighborhood) => {\r\n            var restaurants = [];\r\n            return dbPromise\r\n                .then(db => {\r\n                    db.transaction(RESTAURANTS)\r\n                        .objectStore(RESTAURANTS)\r\n                        .index('by-neighborhood')\r\n                        .openCursor(IDBKeyRange.only(neighborhood))\r\n                        .then(function cursorIterate(cursor) {\r\n                            if (!cursor) return;\r\n                            console.log(cursor.value);\r\n                            restaurants.push(cursor.value);\r\n                            return cursor.continue().then(cursorIterate);\r\n                        }).then(() => {\r\n                            return restaurants;\r\n                        })\r\n                });\r\n        },\r\n\r\n        getRestaurantsByCuisineAndNeighborhood: (cuisine, neighborhood) => {\r\n            if (cuisine === 'all' && neighborhood === 'all') {\r\n                return this.DBHelper.getAllRestaurants();\r\n            } else if (cuisine === 'all' && neighborhood !== 'all') {\r\n                return this.DBHelper.getRestaurantsByNeighborhood(neighborhood);\r\n            } else if (cuisine !== 'all' && neighborhood === 'all') {\r\n                return this.DBHelper.getRestaurantsByCuisine(cuisine);\r\n            } else {\r\n                return dbPromise.then(db => {\r\n                    var restaurants = [];\r\n                    db.transaction(RESTAURANTS)\r\n                        .objectStore(RESTAURANTS)\r\n                        .index('by-neighborhood-cuisine')\r\n                        .openCursor(IDBKeyRange.only([neighborhood, cuisine]))\r\n                        .then(function cursorIterate(cursor) {\r\n                            if (!cursor) return;\r\n                            console.log(cursor.value);\r\n                            restaurants.push(cursor.value);\r\n                            return cursor.continue().then(cursorIterate);\r\n                        }).then(() => {\r\n                            return restaurants;\r\n                        })\r\n                })\r\n            }\r\n        },\r\n        /**\r\n         * Map marker for a restaurant.\r\n         */\r\n        mapMarkerForRestaurant: (restaurant, map) => {\r\n            const marker = new google.maps.Marker({\r\n                position: restaurant.latlng,\r\n                title: restaurant.name,\r\n                url: DBHelper.urlForRestaurant(restaurant),\r\n                map: map,\r\n                animation: google.maps.Animation.DROP\r\n            });\r\n            return marker;\r\n        },\r\n        urlForRestaurant: (restaurant) => (\r\n            `./restaurant.html?id=${restaurant.id}`\r\n        ),\r\n        imageUrlForRestaurant: (restaurant) => (\r\n            restaurant.photograph ? `/img/${restaurant.photograph}.webp` : '/img/Map_placeholder.svg'\r\n        )\r\n\r\n\r\n    }\r\n\r\n})();"],"file":"../../js/dbhelper.js"}